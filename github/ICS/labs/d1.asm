.ORIG X3000
LD R6,STACKpos
LD R0,MAPPOS
LDR R1,R0,#0 ; N
ADD R0,R0,#2 ; r0 = MAP
AND R3,R3,#0
LDR R2,R0,#-1 ; M
F1 BRZ F1DONE
    ADD R3,R1,R3 ; R3+ = R1 * R2
    ADD R2,R2,#-1
    BR F1
F1DONE
LDR R2,R0,#-1 ; M
ST  R2,M
NOT R2,R2
ADD R2,R2,#1
ST  R2,NEGM
ADD R3,R3,R0
NOT R3,R3 
ADD R3,R3,#2
ST  R3,NEGMAPENDPOS
ST  R0,POS
LD  R3,POS
LD  R5,NEGMAPENDPOS
ADD R5,R3,R5
F2
    BRP F2DONE
    AND R4,R4,#0
    ADD R4,R4,#-1
    JSR DFS 
    ADD R3,R3,#1
    LD R5 NEGMAPENDPOS
    ADD R5,R3,R5
    BR F2
F2DONE
HALT
M   .BLKW 1
NEGM    .BLKW 1
POS .BLKW 1
RES .BLKW 1
SAVER1  .BLKW   1
MAPPOS .FILL X4000
NEGMAPPOS .FILL XBFFE
NEGMAPENDPOS .BLKW 1
MARKPOS .FILL X5002
OFFSET .FILL X1000
STACKPOS .FILL X8000
DFS 
ADD R6,R6,#-1
STR R7,R6,#0
ADD R6,R6,#-1
STR R3,R6,#0
ADD R6,R6,#-1
STR R4,R6,#0
ADD R6,R6,#-1
STR R1,R6,#0

LD R1,NEGMAPPOS
ADD R1,R1,R3
BRN RETURN0
LD  R1,NEGMAPENDPOS
ADD R1,R1,R3
BRP RETURN0
LDR R1,R3,#0 ;  R1 = MATRIX[I][J]
ADD R2,R4,#0
NOT R2,R2
ADD R2,R2,#1    ;R2 = -PRE
ADD R4,R1,#0    ;R4 = R1
ADD R2,R2,R1 ; NOW - PRE
BRNZ RETURN0
ADD R1,R3,#0
LD  R2,OFFSET
ADD R1,R1,R2 ; R1 = &MARK[i][j]
LDR R2,R1,#0 ; R2 = MARK[i][j]
BRNP RETURN
LD R2,M
ADD R3,R3,R2 ; R3 = R3 + M
JSR DFS ;R0 = DFS1
ADD R1,R0,#0

; ADD R6,R6,#-1
; STR R1,R6,#0

LD R2,NEGM
ADD R3,R2,R3 ;
ADD R3,R2,R3 ;
JSR DFS     ;R0 = DFS2
JSR GETMAX  ;R0= MAX(DFS1,DFS2)
LD  R2,M
ADD R3,R3,R2
ADD R3,R3,#1
ADD R1,R0,#0
JSR DFS
JSR GETMAX
ADD R3,R3,#-2
ADD R1,R0,#0
JSR DFS
ADD R3,R3,#1
JSR GETMAX
ADD R0,R0,#1
LD  R2,OFFSET ; r3 = &mark[i][j]
ADD R2,R3,R2
STR R0,R2,#0 
BR RETURN


RETURN0
AND R0,R0,#0
LDR R1,R6,#0
ADD R6,R6,#1
LDR R4,R6,#0
ADD R6,R6,#1
LDR R3,R6,#0
ADD R6,R6,#1
LDR R7,R6,#0
ADD R6,R6,#1
RET

RETURN
ADD R1,R3,#0
LD  R2,OFFSET
ADD R1,R1,R2 ; R1 = &MARK[i][j]
LDR R0,R1,#0 ; R0 = MARK[i][j]

LDR R1,R6,#0
ADD R6,R6,#1
LDR R4,R6,#0
ADD R6,R6,#1
LDR R3,R6,#0
ADD R6,R6,#1
LDR R7,R6,#0
ADD R6,R6,#1
RET

GETMAX 
ST R1,M1
ST R2,M2
ADD R2,R1,#0
NOT R2,R2
ADD R2,R2,#1
ADD R2,R2,R0
BRP CHOOSER0
ADD R0,R1,#0
CHOOSER0
LD R1,M1
LD R2,M2
RET
M1 .BLKW 1
M2 .BLKW 1


.END

.ORIG X4000
.FILL #2 ; N
.FILL #2 ; M
.FILL #3 ; the map
.FILL #4
.FILL #5
.FILL #6
.END